/******************************************************************************
* MUI-Custom-Class
* (C)2022 M.Volkel (mario.volkel@outlook.com)
*******************************************************************************/

// Comment templates

/******************************************************************************
*
*******************************************************************************/

/*-----------------------------------------------------------------------------
-
------------------------------------------------------------------------------*/

/******************************************************************************
* Header-Files
*******************************************************************************/
#include "main.h"
#include "lfoC.h"
#include "help.h"

#define LFO_BORDER	8

/******************************************************************************
* Class-Methods
*******************************************************************************/
const BYTE lfowaves[256 * 4] =
{
	// Sine
	0,2,5,7,10,12,15,17,20,22,24,27,29,31,34,36,38,41,43,45,47,49,51,53,56,58,60,62,63,65,67,69,71,72,74,76,77,79,80,82,83,84,86,87,88,89,90,91,92,93,94,95,96,96,97,98,98,99,99,99,100,100,100,100,100,100,100,100,100,99,99,99,98,98,97,96,96,95,94,93,92,91,90,89,88,87,86,84,83,82,80,79,77,76,74,72,71,69,67,65,63,62,60,58,56,53,51,49,47,45,43,41,38,36,34,31,29,27,24,22,20,17,15,12,10,7,5,2,0,-2,-5,-7,-10,-12,-15,-17,-20,-22,-24,-27,-29,-31,-34,-36,-38,-41,-43,-45,-47,-49,-51,-53,-56,-58,-60,-62,-63,-65,-67,-69,-71,-72,-74,-76,-77,-79,-80,-82,-83,-84,-86,-87,-88,-89,-90,-91,-92,-93,-94,-95,-96,-96,-97,-98,-98,-99,-99,-99,-100,-100,-100,-100,-100,-100,-100,-100,-100,-99,-99,-99,-98,-98,-97,-96,-96,-95,-94,-93,-92,-91,-90,-89,-88,-87,-86,-84,-83,-82,-80,-79,-77,-76,-74,-72,-71,-69,-67,-65,-63,-62,-60,-58,-56,-53,-51,-49,-47,-45,-43,-41,-38,-36,-34,-31,-29,-27,-24,-22,-20,-17,-15,-12,-10,-7,-5,-2,
	// Triangle
	0,2,3,5,6,8,9,11,13,14,16,17,19,20,22,23,25,27,28,30,31,33,34,36,38,39,41,42,44,45,47,48,50,52,53,55,56,58,59,61,63,64,66,67,69,70,72,73,75,77,78,80,81,83,84,86,88,89,91,92,94,95,97,98,100,98,97,95,94,92,91,89,88,86,84,83,81,80,78,77,75,73,72,70,69,67,66,64,63,61,59,58,56,55,53,52,50,48,47,45,44,42,41,39,38,36,34,33,31,30,28,27,25,23,22,20,19,17,16,14,13,11,9,8,6,5,3,2,0,-2,-3,-5,-6,-8,-9,-11,-12,-14,-16,-17,-19,-20,-22,-23,-25,-27,-28,-30,-31,-33,-34,-36,-37,-39,-41,-42,-44,-45,-47,-48,-50,-52,-53,-55,-56,-58,-59,-61,-62,-64,-66,-67,-69,-70,-72,-73,-75,-77,-78,-80,-81,-83,-84,-86,-87,-89,-91,-92,-94,-95,-97,-98,-100,-98,-97,-95,-94,-92,-91,-89,-88,-86,-84,-83,-81,-80,-78,-77,-75,-73,-72,-70,-69,-67,-66,-64,-63,-61,-59,-58,-56,-55,-53,-52,-50,-48,-47,-45,-44,-42,-41,-39,-38,-36,-34,-33,-31,-30,-28,-27,-25,-23,-22,-20,-19,-17,-16,-14,-13,-11,-9,-8,-6,-5,-3,-2,
	// Sawtooth
	0,1,2,2,3,4,5,5,6,7,8,9,9,10,11,12,13,13,14,15,16,16,17,18,19,20,20,21,22,23,23,24,25,26,27,27,28,29,30,30,31,32,33,34,34,35,36,37,38,38,39,40,41,41,42,43,44,45,45,46,47,48,48,49,50,51,52,52,53,54,55,55,56,57,58,59,59,60,61,62,62,63,64,65,66,66,67,68,69,70,70,71,72,73,73,74,75,76,77,77,78,79,80,80,81,82,83,84,84,85,86,87,87,88,89,90,91,91,92,93,94,95,95,96,97,98,98,99,100,-99,-98,-98,-97,-96,-95,-95,-94,-93,-92,-91,-91,-90,-89,-88,-88,-87,-86,-85,-84,-84,-83,-82,-81,-80,-80,-79,-78,-77,-77,-76,-75,-74,-73,-73,-72,-71,-70,-70,-69,-68,-67,-66,-66,-65,-64,-63,-63,-62,-61,-60,-59,-59,-58,-57,-56,-55,-55,-54,-53,-52,-52,-51,-50,-49,-48,-48,-47,-46,-45,-45,-44,-43,-42,-41,-41,-40,-39,-38,-38,-37,-36,-35,-34,-34,-33,-32,-31,-30,-30,-29,-28,-27,-27,-26,-25,-24,-23,-23,-22,-21,-20,-20,-19,-18,-17,-16,-16,-15,-14,-13,-13,-12,-11,-10,-9,-9,-8,-7,-6,-5,-5,-4,-3,-2,-2,-1,
	// Square
	100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,-100,
};

/*-----------------------------------------------------------------------------
- OM_NEW
------------------------------------------------------------------------------*/
ULONG lfoC_New(struct IClass *cl, Object *obj, struct opSet *msg)
{
	struct lfoC_Data tmp = {0};
	struct TagItem *tags;

	tags = msg->ops_AttrList;
	tmp.chn = (UBYTE)GetTagData(MUIA_lfoC_Channel, 0, tags);

	if (obj = (Object *)DoSuperMethodA(cl, obj, (APTR)msg))
	{
		struct lfoC_Data *data = INST_DATA(cl, obj);
		*data = tmp;
		return (ULONG)obj;
	}
	CoerceMethod(cl, obj, OM_DISPOSE);
	return 0;
}

/*-----------------------------------------------------------------------------
- AskMinMax-Method
------------------------------------------------------------------------------*/
ULONG lfoC_mAskMinMax(struct IClass *cl, Object *obj, struct MUIP_AskMinMax *msg)
{
	DoSuperMethodA(cl, obj, (Msg)msg);

	msg->MinMaxInfo->MinWidth += 75;
	msg->MinMaxInfo->DefWidth += 75;
	msg->MinMaxInfo->MaxWidth += 75;

	msg->MinMaxInfo->MinHeight += 75;
	msg->MinMaxInfo->DefHeight += 75;
	msg->MinMaxInfo->MaxHeight += 75;

	return (0);
}

/*-----------------------------------------------------------------------------
- Draw-Method
------------------------------------------------------------------------------*/
ULONG lfoC_mDraw(struct IClass *cl, Object *obj, struct MUIP_Draw *msg)
{
	int i, x, y;
	struct lfoC_Data *data = INST_DATA(cl, obj);

	DoSuperMethodA(cl, obj, (Msg)msg);

	// Clear Background
	SetAPen(_rp(obj), _dri(obj)->dri_Pens[BACKGROUNDPEN]);
	RectFill(_rp(obj), _mleft(obj), _mtop(obj), _mright(obj), _mbottom(obj));

	// Draw Waveform
	SetAPen(_rp(obj), _dri(obj)->dri_Pens[TEXTPEN]);

	for (i = 0; i < 255; i++)
	{
		x = lfoC_transformX(obj, i);
		y = lfoC_transformY(obj, lfowaves[(256 * LFOWave[data->chn]) + i] + LFOOffset[data->chn]);

		// some clipping
		if (y < _mtop(obj))
			y = _mtop(obj);

		if (y > _mbottom(obj))
			y = _mbottom(obj);

		WritePixel(_rp(obj), x, y);
	}

	data->oldPhase = phaseCnt[data->chn];

	return (0);
}

/*-----------------------------------------------------------------------------
- mUpdate()
------------------------------------------------------------------------------*/
ULONG lfoC_mUpdate(struct IClass *cl, Object *obj, struct MUIP_Draw *msg)
{
	int i, x, y, start, end;
	struct lfoC_Data *data = INST_DATA(cl, obj);

	DoSuperMethodA(cl, obj, (Msg)msg);

	// Clear Cursor
	SetAPen(_rp(obj), _dri(obj)->dri_Pens[DETAILPEN]);
	x = lfoC_transformX(obj, data->oldPhase);
	Move(_rp(obj), x, _mtop(obj));
	Draw(_rp(obj), x, _mbottom(obj));

	// Draw Cursor
	SetAPen(_rp(obj), _dri(obj)->dri_Pens[FILLPEN]);
	x = lfoC_transformX(obj, phaseCnt[data->chn]);
	Move(_rp(obj), x, _mtop(obj));
	Draw(_rp(obj), x, _mbottom(obj));

	if (data->oldPhase < 2)
	{
		start = 0;
		end = 1;
	}
	else if (data->oldPhase > 255 - 2)
	{
		start = 255 - 2;
		end = 255;
	}
	else
	{
		start = data->oldPhase - 2;
		end = data->oldPhase + 2;
	}

	SetAPen(_rp(obj), _dri(obj)->dri_Pens[TEXTPEN]);
	for (i = start; i < end; i++)
	{
		x = lfoC_transformX(obj, i);
		y = lfoC_transformY(obj, lfowaves[(256 * LFOWave[data->chn]) + i] + LFOOffset[data->chn]);

		// some clipping
		if (y < _mtop(obj))
			y = _mtop(obj);

		if (y > _mbottom(obj))
			y = _mbottom(obj);

		WritePixel(_rp(obj), x, y);
	}

	data->oldPhase = phaseCnt[data->chn];

	return (0);
}

/*-----------------------------------------------------------------------------
- lfoC_transformX()
------------------------------------------------------------------------------*/
int lfoC_transformX(Object *obj, int x)
{
	int xMin = 0;
	int xMax = 255;
	return (_mleft(obj) + (LFO_BORDER / 2)) + (((_mwidth(obj) - LFO_BORDER) * (x - xMin)) / (xMax - xMin));
}

/*-----------------------------------------------------------------------------
- lfoC_transformY()
------------------------------------------------------------------------------*/
int lfoC_transformY(Object *obj, int y)
{
	int yMin = -100;
	int yMax = 100;
	return (_mtop(obj) + (LFO_BORDER / 2)) + (((_mheight(obj) - LFO_BORDER) * (y - yMin)) / (yMax - yMin));
}

/*-----------------------------------------------------------------------------
- Class-Dispatcher
------------------------------------------------------------------------------*/
DISPATCHER(lfoC_Dispatcher)
{
	switch (msg->MethodID)
	{
		case OM_NEW:
			return lfoC_New(cl, obj, (APTR)msg);

		case MUIM_AskMinMax:
			return (lfoC_mAskMinMax(cl, obj, (APTR)msg));

		case MUIM_Draw:
			return (lfoC_mDraw(cl, obj, (APTR)msg));

		case MUIM_lfoC_Update:
			return (lfoC_mUpdate(cl, obj, (APTR)msg));
	}

	return (DoSuperMethodA(cl, obj, msg));
}
